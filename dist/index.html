<!DOCTYPE html>
<html lang="en">
<!-- 組員上傳就要執行這段指令同步 git pull origin main -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-liquidfill@3/dist/echarts-liquidfill.min.js"></script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>健習生｜健康儀表板</title>
    <link rel="icon" href="images/fitness.png" type="image/png">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/bootstrap.css">
    <link rel="stylesheet" href="assets/vendors/iconly/bold.css">

    <link rel="stylesheet" href="assets/vendors/bootstrap-icons/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/app.css">

    <link rel="stylesheet" href="assets/css/chatbox.css" />
    <link rel="shortcut icon" href="assets/images/favicon.svg" type="image/x-icon">

    <style>
        .stats-icon.orange {
            background-color: #ff9500;
            color: white;
        }

        .stats-icon.teal {
            background-color: #20c997;
            color: white;
        }

        .stats-icon.indigo {
            background-color: #6610f2;
            color: white;
        }

        .stats-icon.pink {
            background-color: #e83e8c;
            color: white;
        }

        /* 確保主要內容區域可以滾動 */
        #main {
            height: 100vh !important;
            overflow-y: auto !important;
        }

        /* 確保內容足夠長以觸發滾動 */
        .page-content {
            min-height: 120vh !important;
            padding-bottom: 50px !important;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        .card {
            border-radius: 16px;
            /* 統一圓角 */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            /* 柔和陰影 */
            margin-bottom: 20px;
            /* 下方留白 */
        }

        .card .card-body {
            padding: 1.25rem;
            /* 讓內距一致 */
        }

        .card-body {
            padding-top: 1.5rem !important;
            /* 預設大約 1rem，加大一點 */
            padding-bottom: 1.5rem !important;
        }

        .col-lg-3 .card {
            margin-bottom: 24px;
        }

        .card-header {
            padding: 1.2rem 1rem !important;
            /* 上下間距 */
            background-color: #f5f7fa;
            /* 淡淡的灰藍色背景 */
            border-bottom: 1px solid #e0e0e0;
            /* 下邊框淡灰 */
            border-radius: 12px 12px 0 0;
            /* 讓標題區域圓角更柔和 */
        }

        .card-header h4 {
            margin: 0;
            line-height: 1.6;
            font-size: 1.25rem;
            font-weight: 700;
            color: #34495e;
            /* 深灰藍，文字更穩重 */
        }
    </style>
</head>

<body>
    <div id="app">

        <!-- 聊天氣泡 -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

        <div id="chat-container" class="position-relative">
            <div id="chat-icon" class="chat-icon">
                <img src="assets/images/chat-icon.png" alt="chat icon" />`
            </div>
            <div id="chat-window" class="chat-window">
                <div class="header">AI健習生</div>
                <div class="body">
                    <div class="message">你好，有什麼可以幫忙的嗎？</div>
                    <div id="user-id" style="display: none;"></div>
                </div>
                <div class="footer">
                    <input type="text" placeholder="輸入訊息..." />
                    <button>發送</button>
                </div>
            </div>
        </div>

        <script src="assets/js/chatbox.js"></script>
        <!-- 聊天氣泡結束 -->

        <div id="sidebar" class="active">
            <div class="sidebar-wrapper active">
                <div class="sidebar-menu">
                    <ul class="menu">
                        <li class="sidebar-title">我的檔案</li>

                        <li class="sidebar-item active">
                            <a href="index.html" class='sidebar-link'>
                                <i class="bi bi-file-earmark-medical-fill"></i>
                                <span>健康儀表板</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a href="profile.html" class='sidebar-link'>
                                <i class="bi bi-person-badge-fill"></i>
                                <span>基本資料</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a href="history.html" class='sidebar-link'>
                                <i class="bi bi-pen-fill"></i>
                                <span>歷史紀錄</span>
                            </a>
                        </li>
                        <li class="sidebar-title">智慧建議</li>
                        <li class="sidebar-item">
                            <a href="training.html" class='sidebar-link'>
                                <i class="bi bi-pentagon-fill"></i>
                                <span>訓練探索</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a href="food.html" class='sidebar-link'>
                                <i class="bi bi-basket-fill"></i>
                                <span>飲食指南</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a href="favorite.html" class='sidebar-link'>
                                <i class="bi bi-grid-1x2-fill"></i>
                                <span>我的最愛</span>
                            </a>
                        </li>
                        <li class="sidebar-title">更多選項</li>
                        <li class="sidebar-item">
                            <a href="logout.php" class='sidebar-link'>
                                <i class="bi bi-egg-fill"></i>
                                <span>登出帳戶</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <button class="sidebar-toggler btn x"><i data-feather="x"></i></button>
            </div>
        </div>
        <div id="main">
            <header class="mb-3">
                <a href="#" class="burger-btn d-block d-xl-none">
                    <i class="bi bi-justify fs-3"></i>
                </a>
            </header>

            <div class="page-heading">
                <div class="d-flex align-items-center">
                    <h3 class="mb-0 me-3">健康儀表板🔎
                    </h3>
                    <button class="btn btn-custom d-flex align-items-center" data-bs-toggle="modal"
                        data-bs-target="#addDataModal">
                        <i class="bi bi-plus-circle me-2"></i>新增數據
                    </button>
                </div>
            </div>
            <p class="text-muted mt-2 mb-4" style="font-size: 1rem;">
                以下為您目前最新的基本身體資料，系統會自動統計最近一次的數值顯示於下方。
            </p>
            <div class="page-content">
                <section class="row">
                    <div class="col-12 col-lg-9">
                        <div class="row">
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <!-- 紫色 ICON -->
                                            <div class="stats-icon morandi-purple me-3">
                                                <img src="icons/clipboard-data.svg" alt="Clipboard Data"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <!-- 文字內容 -->
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold">記錄筆數</h6>
                                                <h6 class="font-extrabold mb-0" id="total-records">0 筆</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon morandi-blue me-3">
                                                <img src="icons/ruler-combined-solid.svg" alt="Ruler-Combined-Solid"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold">身高</h6>
                                                <h6 class="font-extrabold mb-0" id="avg-height">0.0 cm</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon morandi-green me-3">
                                                <img src="icons/speedometer2.svg" alt="speedometer2"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold">體重</h6>
                                                <h6 class="font-extrabold mb-0" id="avg-weight">0.0 kg</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon morandi-pink me-3">
                                                <img src="icons/clipboard-account.svg" alt="clipboard-account"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold">BMI</h6>
                                                <h6 class="font-extrabold mb-0" id="avg-bmi">0.0</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon morandi-apricot me-3">
                                                <img src="icons/fire-solid.svg" alt="muscle-gain"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold">基礎代謝</h6>
                                                <h6 class="font-extrabold mb-0" id="avg-metabolism">0 kcal</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon morandi-graygreen me-3">
                                                <img src="icons/muscle-gain.svg" alt="muscle-gain"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold">骨骼肌</h6>
                                                <h6 class="font-extrabold mb-0" id="avg-skeletal">0.0 kg</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon morandi-gray me-3">
                                                <img src="icons/pie-chart.svg" alt="muscle-gain"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold">體脂肪</h6>
                                                <h6 class="font-extrabold mb-0" id="avg-body-fat">0.0 kg</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon morandi-cream me-3">
                                                <img src="icons/add-chart.svg" alt="muscle-gain"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold">體脂率</h6>
                                                <h6 class="font-extrabold mb-0" id="avg-fat-percentage">0.0%</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card text-center">體重變化趨勢</h4>
                                    </div>
                                    <div class="card-body">
                                        <div id="weight-chart"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card text-center">身體組成變化</h4>
                                    </div>
                                    <div class="card-body">
                                        <div id="body-composition-chart"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card text-center">體脂率變化趨勢</h4>
                                    </div>
                                    <div class="card-body">
                                        <div id="fat-percentage-chart"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card text-center">BMI變化趨勢</h4>
                                    </div>
                                    <div class="card-body">
                                        <div id="bmi-chart"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-3">
                        <div class="card">
                            <div class="card-body py-4 px-5">
                                <div class="d-flex align-items-center">
                                    <div class="avatar avatar-xl">
                                        <img src="assets/images/faces/1.jpg" alt="Face 1">
                                    </div>
                                    <div class="ms-3 name">
                                        <h5 class="font-bold" id="user-name">John Duck</h5>
                                        <h6 class="text-muted mb-0" id="user-email">@johnducky</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card text-center">
                            <div class="card-header">
                                <h4 class="fw-bold">健康目標追蹤</h4>
                            </div>
                            <div class="card-content pb-4">

                                <!-- ✅ 每一列包在 w-75 的 container，並靠中對齊 -->
                                <div class="mx-auto w-75 d-flex align-items-center justify-content-start py-3">
                                    <div class="goal-icon rounded-circle d-flex align-items-center justify-content-center me-3"
                                        style="width: 40px; height: 40px; background-color: #c1cdd7; overflow: hidden;">
                                        <img src="images/barbell.png" alt="目標體重"
                                            style="width: 60%; height: 60%; object-fit: contain; filter: brightness(0) invert(1);">
                                    </div>
                                    <div class="text-start">
                                        <h6 class="mb-1 fw-bold">目標體重</h6>
                                        <p class="text-muted mb-0">70.0 kg</p>
                                    </div>
                                </div>

                                <div class="mx-auto w-75 d-flex align-items-center justify-content-start py-3">
                                    <div class="goal-icon rounded-circle d-flex align-items-center justify-content-center me-3"
                                        style="width: 40px; height: 40px; background-color: #cfddd6; overflow: hidden;">
                                        <img src="images/up.png" alt="目標體脂率"
                                            style="width: 60%; height: 60%; object-fit: contain; filter: brightness(0) invert(1);">
                                    </div>
                                    <div class="text-start">
                                        <h6 class="mb-1 fw-bold">目標體脂率</h6>
                                        <p class="text-muted mb-0">15.0%</p>
                                    </div>
                                </div>

                                <div class="mx-auto w-75 d-flex align-items-center justify-content-start py-3">
                                    <div class="goal-icon rounded-circle d-flex align-items-center justify-content-center me-3"
                                        style="width: 40px; height: 40px; background-color: #e6d4da; overflow: hidden;">
                                        <img src="images/line-chart.png" alt="目標肌肉量"
                                            style="width: 60%; height: 60%; object-fit: contain; filter: brightness(0) invert(1);">
                                    </div>
                                    <div class="text-start">
                                        <h6 class="mb-1 fw-bold">目標肌肉量</h6>
                                        <p class="text-muted mb-0">35.0 kg</p>
                                    </div>
                                </div>
                                <div class="px-4">
                                    <button class="btn btn-block btn-xl btn-light-primary font-bold mt-3">設定目標</button>
                                </div>
                            </div>
                        </div>
                        <div class="card text-center equal-h">
                            <div class="card-header">
                                <h4 class="fw-bold">目標達成率</h4>
                            </div>
                            <div class="card-body d-flex flex-column justify-content-center align-items-center">
                                <div id="goal-progress-chart"
                                    style="width: 100%; aspect-ratio: 1/1; max-height: 200px;"></div>
                                <p class="mt-3 text-muted">離目標只差一點，加油！</p>
                            </div>
                        </div>
                        <div class="card equal-h">
                            <div class="card-header">
                                <h4 class="text-center">身體組成比例</h4>
                            </div>
                            <div class="card-body d-flex flex-column justify-content-center align-items-center">
                                <div id="body-composition-pie-chart"></div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <footer>
                <div class="footer clearfix mb-0 text-muted">
                    <div class="float-start">
                        <p>健習生</p>
                    </div>
                    <div class="float-end">
                        <p>謝昀倢 黃詠翰 呂沁垣 游博翔</p>
                    </div>
                </div>
            </footer>
        </div>
    </div>
    <script src="assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>

    <script src="assets/vendors/apexcharts/apexcharts.js"></script>
    <script src="assets/js/pages/dashboard.js"></script>

    <script src="assets/js/main.js"></script>

    <!-- 新增數據彈出視窗 -->
    <div class="modal fade" id="addDataModal" tabindex="-1" aria-labelledby="addDataModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addDataModalLabel">新增健康數據</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="healthDataForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="test_date" class="form-label">測量日期</label>
                                <input type="date" class="form-control" id="test_date" name="test_date">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="age" class="form-label">年齡 *</label>
                                <input type="number" class="form-control" id="age" name="age" min="1" max="120"
                                    required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="height_cm" class="form-label">身高 (cm) *</label>
                                <input type="number" class="form-control" id="height_cm" name="height_cm" step="0.1"
                                    min="50" max="250" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="weight_kg" class="form-label">體重 (kg) *</label>
                                <input type="number" class="form-control" id="weight_kg" name="weight_kg" step="0.1"
                                    min="20" max="300" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="skeletal_muscle" class="form-label">骨骼肌重 (kg)</label>
                                <input type="number" class="form-control" id="skeletal_muscle" name="skeletal_muscle"
                                    step="0.1">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="body_fat" class="form-label">體脂肪重 (kg)</label>
                                <input type="number" class="form-control" id="body_fat" name="body_fat" step="0.1">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fat_percentage" class="form-label">體脂率 (%)</label>
                                <input type="number" class="form-control" id="fat_percentage" name="fat_percentage"
                                    step="0.1">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="basal_metabolism" class="form-label">基礎代謝量 (kcal)</label>
                                <input type="number" class="form-control" id="basal_metabolism" name="basal_metabolism"
                                    step="0.1">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="bmi" class="form-label">BMI (可選)</label>
                                <input type="number" class="form-control" id="bmi" name="bmi" step="0.1">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveDataBtn">保存數據</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 成功提示視窗 -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">成功</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="successMessage">數據保存成功！</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">確定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 錯誤提示視窗 -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">錯誤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="errorMessage">保存數據時發生錯誤。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">確定</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 設置今天的日期為默認值（使用本地時區）
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('test_date').value = `${year}-${month}-${day}`;

        // 載入用戶資訊
        fetch('get_user_info.php')
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    // 如果未登入，跳轉到登入頁面
                    window.location.href = 'auth-login.html';
                    throw new Error('Not logged in');
                }
            })
            .then(data => {
                // 更新用戶資訊
                document.getElementById('user-id').textContent = data.userid;
                document.getElementById('user-name').textContent = data.username;
                document.getElementById('user-email').textContent = data.email;
            })
            .catch(error => {
                console.error('Error loading user info:', error);
            });

        // 載入健康數據統計
        fetch('get_health_stats.php')
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Failed to load health stats');
                }
            })
            .then(data => {
                // 更新統計數據（顯示最新記錄）
                document.getElementById('total-records').textContent = data.total_records + ' 筆';
                document.getElementById('avg-weight').textContent = data.latest_weight + ' kg';
                document.getElementById('avg-height').textContent = data.latest_height + ' cm';
                document.getElementById('avg-skeletal').textContent = data.latest_skeletal_muscle + ' kg';
                document.getElementById('avg-body-fat').textContent = data.latest_body_fat + ' kg';
                document.getElementById('avg-fat-percentage').textContent = data.latest_fat_percentage + '%';
                document.getElementById('avg-metabolism').textContent = data.latest_basal_metabolism + ' kcal';
                document.getElementById('avg-bmi').textContent = data.latest_bmi;
            })
            .catch(error => {
                console.error('Error loading health stats:', error);
            });

        // 載入圖表數據
        function loadChartData() {
            fetch('get_chart_data.php')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Failed to load chart data');
                    }
                })
                .then(data => {
                    if (data.dates && data.dates.length > 0) {
                        createWeightChart(data);
                        createBodyCompositionChart(data);
                        createFatPercentageChart(data);
                        createBMIChart(data);
                    }
                })
                .catch(error => {
                    console.error('Error loading chart data:', error);
                });
        }

        // 創建體重變化圖表
        function createWeightChart(data) {
            const weightData = data.weight.filter(val => val !== null);
            const dates = data.dates.filter((_, index) => data.weight[index] !== null);

            if (weightData.length === 0) return;

            const options = {
                series: [{
                    name: '體重 (kg)',
                    data: weightData
                }],
                chart: {
                    type: 'line',
                    height: 390,
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#AB8B8B'],
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val.toFixed(1);
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                xaxis: {
                    categories: dates,
                    labels: {
                        formatter: function (value) {
                            return new Date(value).toLocaleDateString('zh-TW', {
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: '體重 (kg)'
                    }
                },
                tooltip: {
                    x: {
                        format: 'dd/MM/yyyy'
                    }
                }
            };

            const chart = new ApexCharts(document.querySelector("#weight-chart"), options);
            chart.render();
        }

        // 創建身體組成圖表
        function createBodyCompositionChart(data) {
            const skeletalData = data.skeletal_muscle.filter(val => val !== null);
            const bodyFatData = data.body_fat.filter(val => val !== null);
            const dates = data.dates.filter((_, index) =>
                data.skeletal_muscle[index] !== null || data.body_fat[index] !== null
            );

            if (skeletalData.length === 0 && bodyFatData.length === 0) return;

            const options = {
                series: [{
                    name: '骨骼肌重 (kg)',
                    data: skeletalData
                }, {
                    name: '體脂肪重 (kg)',
                    data: bodyFatData
                }],
                chart: {
                    type: 'line',
                    height: 390,
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#99898C', '#60575A'],
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val.toFixed(1);
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                xaxis: {
                    categories: dates,
                    labels: {
                        formatter: function (value) {
                            return new Date(value).toLocaleDateString('zh-TW', {
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: '重量 (kg)'
                    }
                },
                tooltip: {
                    x: {
                        format: 'dd/MM/yyyy'
                    }
                }
            };

            const chart = new ApexCharts(document.querySelector("#body-composition-chart"), options);
            chart.render();
        }

        // 創建體脂率變化圖表
        function createFatPercentageChart(data) {
            const fatPercentageData = data.fat_percentage.filter(val => val !== null);
            const dates = data.dates.filter((_, index) => data.fat_percentage[index] !== null);

            if (fatPercentageData.length === 0) return;

            const options = {
                series: [{
                    name: '體脂率 (%)',
                    data: fatPercentageData
                }],
                chart: {
                    type: 'line',
                    height: 390,
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#745E60'],
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val.toFixed(1);
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                xaxis: {
                    categories: dates,
                    labels: {
                        formatter: function (value) {
                            return new Date(value).toLocaleDateString('zh-TW', {
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: '體脂率 (%)'
                    }
                },
                tooltip: {
                    x: {
                        format: 'dd/MM/yyyy'
                    }
                }
            };

            const chart = new ApexCharts(document.querySelector("#fat-percentage-chart"), options);
            chart.render();
        }

        // 創建BMI變化圖表
        function createBMIChart(data) {
            const bmiData = data.bmi.filter(val => val !== null);
            const dates = data.dates.filter((_, index) => data.bmi[index] !== null);

            if (bmiData.length === 0) return;

            const options = {
                series: [{
                    name: 'BMI',
                    data: bmiData
                }],
                chart: {
                    type: 'line',
                    height: 390,
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#9C7178'],
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val.toFixed(1);
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                xaxis: {
                    categories: dates,
                    labels: {
                        formatter: function (value) {
                            return new Date(value).toLocaleDateString('zh-TW', {
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'BMI'
                    }
                },
                tooltip: {
                    x: {
                        format: 'dd/MM/yyyy'
                    }
                }
            };

            const chart = new ApexCharts(document.querySelector("#bmi-chart"), options);
            chart.render();
        }

        // 載入圖表數據
        loadChartData();
        // 目標達成率圓環圖
        function createGoalProgressChart() {
            var chartDom = document.querySelector("#goal-progress-chart");
            var myChart = echarts.init(chartDom);

            var option = {
                series: [{
                    type: 'liquidFill',
                    data: [0.72], // 72%
                    radius: '65%',
                    center: ['50%', '50%'],
                    outline: {
                        show: true,
                        borderDistance: 3,
                        itemStyle: {
                            borderWidth: 2,
                            borderColor: '#6b7b8c'
                        }
                    },
                    backgroundStyle: { color: '#f5f7fa' },
                    label: {
                        normal: {
                            formatter: '72%',
                            fontSize: 20,
                            color: '#34495e',
                            fontWeight: 'bold'
                        }
                    },
                    color: [{
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            { offset: 0, color: '#9c99a2' },
                            { offset: 1, color: '#cddce6' }
                        ]
                    }]
                }]
            };

            myChart.setOption(option);

            // ✅ 讓圖表跟隨視窗大小縮放
            window.addEventListener("resize", function () {
                myChart.resize();
            });
        }
        createGoalProgressChart();

        // 創建身體組成比例圓餅圖
        function createBodyCompositionPieChart() {
            fetch('get_health_stats.php')
                .then(response => response.json())
                .then(data => {
                    const latestSkeletal = parseFloat(data.latest_skeletal_muscle) || 0;
                    const latestBodyFat = parseFloat(data.latest_body_fat) || 0;
                    const latestWeight = parseFloat(data.latest_weight) || 0;

                    // 計算其他組成（體重 - 骨骼肌 - 體脂肪）
                    const otherComposition = Math.max(0, latestWeight - latestSkeletal - latestBodyFat);

                    const options = {
                        series: [latestSkeletal, latestBodyFat, otherComposition],
                        chart: {
                            type: 'donut',
                            height: 260
                        },
                        labels: ['骨骼肌', '體脂肪', '其他'],
                        colors: ['#BFC5DB', '#B2ABC5', '#C7C7C7'],
                        dataLabels: {
                            enabled: true,
                            formatter: function (val, opts) {
                                return opts.w.globals.series[opts.seriesIndex].toFixed(1) + ' kg';
                            }
                        },
                        legend: {
                            position: 'bottom'
                        },
                        plotOptions: {
                            pie: {
                                donut: {
                                    size: '60%',
                                    labels: {
                                        show: true,
                                        total: {
                                            show: true,
                                            label: '總重量',
                                            formatter: function (w) {
                                                return w.globals.seriesTotals.reduce((a, b) => a + b, 0).toFixed(1) + ' kg';
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    };

                    const chart = new ApexCharts(document.querySelector("#body-composition-pie-chart"), options);
                    chart.render();
                })
                .catch(error => {
                    console.error('Error creating body composition pie chart:', error);
                });
        }

        // 載入身體組成比例圖表
        createBodyCompositionPieChart();

        // 保存數據按鈕點擊事件
        document.getElementById('saveDataBtn').addEventListener('click', function () {
            // 顯示保存中狀態
            const saveBtn = document.getElementById('saveDataBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '保存中...';

            const form = document.getElementById('healthDataForm');
            const formData = new FormData(form);

            // 將FormData轉換為JSON對象
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            // 發送數據到服務器
            fetch('save_health_data.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    // 恢復按鈕狀態
                    saveBtn.disabled = false;
                    saveBtn.textContent = '保存數據';

                    if (result.success) {
                        // 顯示成功消息
                        document.getElementById('successMessage').textContent = result.message;
                        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                        successModal.show();

                        // 關閉新增數據視窗
                        const addDataModal = bootstrap.Modal.getInstance(document.getElementById('addDataModal'));
                        addDataModal.hide();

                        // 重置表單
                        form.reset();
                        // 重新設置今天的日期為默認值
                        const today = new Date();
                        const year = today.getFullYear();
                        const month = String(today.getMonth() + 1).padStart(2, '0');
                        const day = String(today.getDate()).padStart(2, '0');
                        document.getElementById('test_date').value = `${year}-${month}-${day}`;

                        // 重新載入統計數據
                        fetch('get_health_stats.php')
                            .then(response => response.json())
                            .then(data => {
                                document.getElementById('total-records').textContent = data.total_records + ' 筆';
                                document.getElementById('avg-weight').textContent = data.latest_weight + ' kg';
                                document.getElementById('avg-height').textContent = data.latest_height + ' cm';
                                document.getElementById('avg-skeletal').textContent = data.latest_skeletal_muscle + ' kg';
                                document.getElementById('avg-body-fat').textContent = data.latest_body_fat + ' kg';
                                document.getElementById('avg-fat-percentage').textContent = data.latest_fat_percentage + '%';
                                document.getElementById('avg-metabolism').textContent = data.latest_basal_metabolism + ' kcal';
                                document.getElementById('avg-bmi').textContent = data.latest_bmi;
                            })
                            .catch(error => {
                                console.error('Error reloading health stats:', error);
                            });

                        // 重新載入圖表數據
                        loadChartData();
                    } else {
                        // 顯示錯誤消息
                        document.getElementById('errorMessage').textContent = result.error || '保存數據時發生錯誤';
                        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                        errorModal.show();
                    }
                })
                .catch(error => {
                    // 恢復按鈕狀態
                    saveBtn.disabled = false;
                    saveBtn.textContent = '保存數據';

                    console.error('Error:', error);
                    document.getElementById('errorMessage').textContent = '網絡錯誤，請稍後再試';
                    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                    errorModal.show();
                });
        });
    </script>
</body>

</html>