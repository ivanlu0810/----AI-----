<!DOCTYPE html>
<html lang="en">
<!-- çµ„å“¡ä¸Šå‚³å°±è¦åŸ·è¡Œé€™æ®µæŒ‡ä»¤åŒæ­¥ git pull origin main -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-liquidfill@3/dist/echarts-liquidfill.min.js"></script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥ç¿’ç”Ÿï½œå¥åº·å„€è¡¨æ¿</title>
    <link rel="icon" href="images/fitness.png" type="image/png">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/bootstrap.css">
    <link rel="stylesheet" href="assets/vendors/iconly/bold.css">

    <link rel="stylesheet" href="assets/vendors/bootstrap-icons/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/app.css">

    <link rel="stylesheet" href="assets/css/chatbox.css" />
    <link rel="shortcut icon" href="assets/images/favicon.svg" type="image/x-icon">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>

    <style>
        .stats-icon.orange {
            background-color: #ff9500;
            color: white;
        }

        .stats-icon.teal {
            background-color: #20c997;
            color: white;
        }

        .stats-icon.indigo {
            background-color: #6610f2;
            color: white;
        }

        .stats-icon.pink {
            background-color: #e83e8c;
            color: white;
        }

        /* ç¢ºä¿ä¸»è¦å…§å®¹å€åŸŸå¯ä»¥æ»¾å‹• */
        #main {
            height: 100vh !important;
            overflow-y: auto !important;
        }

        /* ç¢ºä¿å…§å®¹è¶³å¤ é•·ä»¥è§¸ç™¼æ»¾å‹• */
        .page-content {
            min-height: 120vh !important;
            padding-bottom: 50px !important;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        .card {
            border-radius: 16px;
            /* çµ±ä¸€åœ“è§’ */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            /* æŸ”å’Œé™°å½± */
            margin-bottom: 20px;
            /* çµ±ä¸€ä¸Šä¸‹é–“è· */
            margin-top: 20px;
        }

        .card .card-body {
            padding: 1rem;
            /* æ¸›å°‘å…§è· */
        }

        .card-body {
            padding-top: 1.25rem !important;
            /* æ¸›å°‘ä¸Šä¸‹å…§è· */
            padding-bottom: 1.25rem !important;
        }

        .col-lg-3 .card {
            margin-bottom: 20px;
            margin-top: 20px;
        }

        /* çµ±è¨ˆå¡ç‰‡ç·Šæ¹Šæ¨£å¼ */
        .stats-card .card-body {
            padding: 0.75rem 1rem !important;
        }

        .stats-card h6 {
            margin-bottom: 0.25rem !important;
        }

        .card-header {
            padding: 1rem 1rem !important;
            /* æ¸›å°‘ä¸Šä¸‹é–“è· */
            background-color: #f5f7fa;
            /* æ·¡æ·¡çš„ç°è—è‰²èƒŒæ™¯ */
            border-bottom: 1px solid #e0e0e0;
            /* ä¸‹é‚Šæ¡†æ·¡ç° */
            border-radius: 12px 12px 0 0;
            /* è®“æ¨™é¡Œå€åŸŸåœ“è§’æ›´æŸ”å’Œ */
        }

        .card-header h4 {
            margin: 0;
            line-height: 1.6;
            font-size: 1.25rem;
            font-weight: 700;
            color: #34495e;
            /* æ·±ç°è—ï¼Œæ–‡å­—æ›´ç©©é‡ */
        }

        /* ç”¨æˆ¶å¤§é ­è²¼æ¨£å¼ */
        .avatar.avatar-xl {
            width: 80px !important;
            height: 80px !important;
            border-radius: 50% !important;
            overflow: hidden;
        }

        .avatar img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            border-radius: 50% !important;
            border: 2px solid #e0e0e0;
            transition: border-color 0.3s ease;
        }

        .avatar img:hover {
            border-color: #95abc3;
        }

        /* è®“å·¦å³æ¬„ä½é«˜åº¦ä¸€è‡´ */
        /* å–æ¶ˆç¬¬ä¸€åˆ—å¡ç‰‡çš„ margin-top */
        .col-lg-9 .row:first-child .card {
            margin-top: 0 !important;
        }

        .col-lg-3 {
            display: flex;
            flex-direction: column;
        }

        /* è®“å¡ç‰‡èƒ½å¡«æ»¿é«˜åº¦ */
        .card {
            flex: 1 1 auto;
        }

        .date-input {
            width: 160px !important;
            /* å¢åŠ å¯¬åº¦ï¼ˆåŸæœ¬140px â†’ 160pxï¼‰ */
            text-align: center;
            /* æ–‡å­—ç½®ä¸­ */
            display: inline-block;
            padding-right: 6px;
            /* é ç•™å…§è·ï¼Œé¿å…æ–‡å­—è²¼é‚Š */
            padding-left: 6px;
        }

        /* åŸºæœ¬æ¨£å¼ */
        .date-btn {
            border: none;
            color: #fff;
            /* é è¨­ç™½å­— */
            font-weight: 600;
            padding: 6px 14px;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }

        /* ä¸‰é¡†æŒ‰éˆ•å„è‡ªé¡è‰² */
        #apply-date-range {
            background-color: #b0bccf;
            /* æ·±è—ç° */
        }

        #apply-date-range:hover {
            background-color: #9daac0;
            /* hover æ·±ä¸€é» */
            color: #fff;
            /* ä¿æŒç™½å­— */
        }

        #reset-date-range {
            background-color: #9aaec7;
            /* ä¸­ç°è— */
        }

        #reset-date-range:hover {
            background-color: #869bb5;
            /* hover æ·±ä¸€é» */
            color: #fff;
        }

        #last-30-days {
            background-color: #c7d3e6;
            /* æ·ºç°è— */
        }

        #last-30-days:hover {
            background-color: #b2bfd8;
            /* hover æ·±ä¸€é» */
            color: #fff;
        }

        .btn-primary {
            background-color: #5A628C !important;
            border-color: #5A628C !important;
            color: #fff !important;
        }

        .btn-primary:hover {
            background-color: #4e567d !important;
            border-color: #4e567d !important;
        }
                
    </style>
</head>

<body>
    <div id="app">

        <!-- èŠå¤©æ°£æ³¡ -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

        <div id="chat-container" class="position-relative">
            <div id="chat-icon" class="chat-icon">
                <img src="assets/images/chat-icon.png" alt="chat icon" />`
            </div>
            <div id="chat-window" class="chat-window">
                <div class="header">AIå¥ç¿’ç”Ÿ</div>
                <div class="body">
                    <div class="message">ä½ å¥½ï¼Œæœ‰ä»€éº¼å¯ä»¥å¹«å¿™çš„å—ï¼Ÿ</div>
                    <div id="user-id" style="display: none;"></div>
                </div>
                <div class="footer">
                    <input type="text" placeholder="è¼¸å…¥è¨Šæ¯..." />
                    <button>ç™¼é€</button>
                </div>
            </div>
        </div>

        <script src="assets/js/chatbox.js"></script>
        <!-- èŠå¤©æ°£æ³¡çµæŸ -->

        <div id="sidebar" class="active">
            <div class="sidebar-wrapper active">
                <div class="sidebar-menu">
                    <ul class="menu">
                        <li class="sidebar-title">æˆ‘çš„æª”æ¡ˆ</li>

                        <li class="sidebar-item active">
                            <a href="index.html" class='sidebar-link'>
                                <i class="bi bi-file-earmark-medical-fill"></i>
                                <span>å¥åº·å„€è¡¨æ¿</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a href="profile.html" class='sidebar-link'>
                                <i class="bi bi-person-badge-fill"></i>
                                <span>åŸºæœ¬è³‡æ–™</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a href="history.html" class='sidebar-link'>
                                <i class="bi bi-pen-fill"></i>
                                <span>æ­·å²ç´€éŒ„</span>
                            </a>
                        </li>
                        <li class="sidebar-title">æ™ºæ…§å»ºè­°</li>
                        <li class="sidebar-item">
                            <a href="training.html" class='sidebar-link'>
                                <i class="bi bi-pentagon-fill"></i>
                                <span>è¨“ç·´æ¢ç´¢</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a href="food.html" class='sidebar-link'>
                                <i class="bi bi-basket-fill"></i>
                                <span>é£²é£ŸæŒ‡å—</span>
                            </a>
                        </li>
                        <li class="sidebar-item">
                            <a href="favorite.html" class='sidebar-link'>
                                <i class="bi bi-grid-1x2-fill"></i>
                                <span>æˆ‘çš„æœ€æ„›</span>
                            </a>
                        </li>
                        <li class="sidebar-title">æ›´å¤šé¸é …</li>
                        <li class="sidebar-item">
                            <a href="logout.php" class='sidebar-link'>
                                <i class="bi bi-egg-fill"></i>
                                <span>ç™»å‡ºå¸³æˆ¶</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <button class="sidebar-toggler btn x"><i data-feather="x"></i></button>
            </div>
        </div>
        <div id="main">
            <header class="mb-3">
                <a href="#" class="burger-btn d-block d-xl-none">
                    <i class="bi bi-justify fs-3"></i>
                </a>
            </header>

            <div class="page-heading">
                <div class="d-flex align-items-center">
                    <h3 class="mb-0 me-3">å¥åº·å„€è¡¨æ¿ğŸ”
                    </h3>
                    <button class="btn btn-custom d-flex align-items-center" data-bs-toggle="modal"
                        data-bs-target="#addDataModal">
                        <i class="bi bi-plus-circle me-2"></i>æ–°å¢æ•¸æ“š
                    </button>
                </div>
            </div>
            <p class="text-muted mt-2 mb-4" style="font-size: 1rem;">
                ä»¥ä¸‹ç‚ºæ‚¨ç›®å‰æœ€æ–°çš„åŸºæœ¬èº«é«”è³‡æ–™ï¼Œç³»çµ±æœƒè‡ªå‹•çµ±è¨ˆæœ€è¿‘ä¸€æ¬¡çš„æ•¸å€¼é¡¯ç¤ºæ–¼ä¸‹æ–¹ã€‚
            </p>
            <div class="page-content">
                <section class="row align-items-stretch">
                    <div class="col-12 col-lg-9 d-flex flex-column">
                        <div class="row">
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card stats-card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <!-- ç´«è‰² ICON -->
                                            <div class="stats-icon morandi-purple me-3">
                                                <img src="icons/clipboard-data.svg" alt="Clipboard Data"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <!-- æ–‡å­—å…§å®¹ -->
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold mb-1">è¨˜éŒ„ç­†æ•¸</h6>
                                                <h6 class="font-extrabold mb-0" id="total-records">0 ç­†</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card stats-card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon morandi-blue me-3">
                                                <img src="icons/ruler-combined-solid.svg" alt="Ruler-Combined-Solid"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold">èº«é«˜</h6>
                                                <h6 class="font-extrabold mb-0" id="avg-height">0.0 cm</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card stats-card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon morandi-green me-3">
                                                <img src="icons/speedometer2.svg" alt="speedometer2"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold">é«”é‡</h6>
                                                <h6 class="font-extrabold mb-0" id="avg-weight">0.0 kg</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card stats-card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon morandi-pink me-3">
                                                <img src="icons/clipboard-account.svg" alt="clipboard-account"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold">BMI</h6>
                                                <h6 class="font-extrabold mb-0" id="avg-bmi">0.0</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card stats-card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon morandi-apricot me-3">
                                                <img src="icons/fire-solid.svg" alt="muscle-gain"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold">åŸºç¤ä»£è¬</h6>
                                                <h6 class="font-extrabold mb-0" id="avg-metabolism">0 kcal</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card stats-card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon morandi-graygreen me-3">
                                                <img src="icons/muscle-gain.svg" alt="muscle-gain"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold">éª¨éª¼è‚Œ</h6>
                                                <h6 class="font-extrabold mb-0" id="avg-skeletal">0.0 kg</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card stats-card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon morandi-gray me-3">
                                                <img src="icons/pie-chart.svg" alt="muscle-gain"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold">é«”è„‚è‚ª</h6>
                                                <h6 class="font-extrabold mb-0" id="avg-body-fat">0.0 kg</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6 col-md-6 col-lg-3">
                                <div class="card stats-card">
                                    <div class="card-body d-flex justify-content-center align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon morandi-cream me-3">
                                                <img src="icons/add-chart.svg" alt="muscle-gain"
                                                    class="icon-svg white-filter">
                                            </div>
                                            <div class="text-center">
                                                <h6 class="text-muted font-semibold">é«”è„‚ç‡</h6>
                                                <h6 class="font-extrabold mb-0" id="avg-fat-percentage">0.0%</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- æ™‚é–“ç¯„åœé¸æ“‡å™¨ -->
                        <div class="row mb-2">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <h6 class="mb-0">åœ–è¡¨æ™‚é–“ç¯„åœ</h6>
                                            <div class="d-flex align-items-center">

                                                <!-- é–‹å§‹æ—¥æœŸ -->
                                                <input type="date" id="start-date" class="form-control me-2 date-input"
                                                    placeholder="å¹´ï¼æœˆï¼æ—¥">
                                                <span class="me-2">è‡³</span>

                                                <!-- çµæŸæ—¥æœŸ -->
                                                <input type="date" id="end-date" class="form-control me-3 date-input"
                                                    placeholder="å¹´ï¼æœˆï¼æ—¥">

                                                <!-- æ“ä½œæŒ‰éˆ• -->
                                                <button class="btn date-btn btn-sm" id="apply-date-range">å¥—ç”¨ç¯„åœ</button>
                                                <button class="btn date-btn btn-sm ms-2"
                                                    id="last-30-days">æœ€è¿‘30å¤©</button>
                                                <button class="btn date-btn btn-sm ms-2"
                                                    id="reset-date-range">é‡ç½®</button>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-0">
                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card text-center">é«”é‡è®ŠåŒ–è¶¨å‹¢</h4>
                                    </div>
                                    <div class="card-body">
                                        <div id="weight-chart"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card text-center">èº«é«”çµ„æˆè®ŠåŒ–</h4>
                                    </div>
                                    <div class="card-body">
                                        <div id="body-composition-chart"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card text-center">é«”è„‚ç‡è®ŠåŒ–è¶¨å‹¢</h4>
                                    </div>
                                    <div class="card-body">
                                        <div id="fat-percentage-chart"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card text-center">BMIè®ŠåŒ–è¶¨å‹¢</h4>
                                    </div>
                                    <div class="card-body">
                                        <div id="bmi-chart"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-lg-3 d-flex flex-column">
                        <div class="card mt-0">
                            <div class="card-body py-4 px-5">
                                <div class="d-flex align-items-center">
                                    <div class="avatar avatar-xl">
                                        <img src="assets/images/faces/1.jpg" alt="é è¨­å¤§é ­è²¼">
                                    </div>
                                    <div class="ms-3 name">
                                        <h5 class="font-bold" id="user-name">John Duck</h5>
                                        <h6 class="text-muted mb-0" id="user-email">@johnducky</h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card text-center mt-3">
                            <div class="card-header">
                                <h4 class="fw-bold">å¥åº·ç›®æ¨™è¿½è¹¤</h4>
                            </div>
                            <div class="card-content pb-4">

                                <!-- âœ… æ¯ä¸€åˆ—åŒ…åœ¨ w-75 çš„ containerï¼Œä¸¦é ä¸­å°é½Š -->
                                <div class="mx-auto w-75 d-flex align-items-start justify-content-start py-3">
                                    <div class="goal-icon rounded-circle d-flex align-items-center justify-content-center me-3"
                                        style="width: 40px; height: 40px; background-color: #c1cdd7; overflow: hidden; flex-shrink: 0;">
                                        <img src="images/barbell.png" alt="ç›®æ¨™é«”é‡"
                                            style="width: 60%; height: 60%; object-fit: contain; filter: brightness(0) invert(1);">
                                    </div>
                                    <div class="text-start flex-grow-1">
                                        <h6 class="mb-2 fw-bold text-dark">ç›®æ¨™é«”é‡</h6>
                                        <div class="d-flex align-items-center" style="min-width: 0;">
                                            <div class="text-muted fw-normal" style="min-width: 80px;">ç›®å‰ï¼š<span
                                                    id="current-weight" class="fw-semibold">0.0</span> kg</div>
                                            <i class="bi bi-arrow-right text-muted mx-2"></i>
                                            <div class="text-primary fw-semibold">ç›®æ¨™ï¼š<span id="goal-weight-display"
                                                    class="fw-bold">70.0</span> kg</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mx-auto w-75 d-flex align-items-start justify-content-start py-3">
                                    <div class="goal-icon rounded-circle d-flex align-items-center justify-content-center me-3"
                                        style="width: 40px; height: 40px; background-color: #cfddd6; overflow: hidden; flex-shrink: 0;">
                                        <img src="images/up.png" alt="ç›®æ¨™é«”è„‚ç‡"
                                            style="width: 60%; height: 60%; object-fit: contain; filter: brightness(0) invert(1);">
                                    </div>
                                    <div class="text-start flex-grow-1">
                                        <h6 class="mb-2 fw-bold text-dark">ç›®æ¨™é«”è„‚ç‡</h6>
                                        <div class="d-flex align-items-center" style="min-width: 0;">
                                            <div class="text-muted fw-normal" style="min-width: 80px;">ç›®å‰ï¼š<span
                                                    id="current-fat-percentage" class="fw-semibold">0.0</span>%</div>
                                            <i class="bi bi-arrow-right text-muted mx-2"></i>
                                            <div class="text-primary fw-semibold">ç›®æ¨™ï¼š<span
                                                    id="goal-fat-percentage-display" class="fw-bold">15.0</span>%</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mx-auto w-75 d-flex align-items-start justify-content-start py-3">
                                    <div class="goal-icon rounded-circle d-flex align-items-center justify-content-center me-3"
                                        style="width: 40px; height: 40px; background-color: #e6d4da; overflow: hidden; flex-shrink: 0;">
                                        <img src="images/line-chart.png" alt="ç›®æ¨™è‚Œè‚‰é‡"
                                            style="width: 60%; height: 60%; object-fit: contain; filter: brightness(0) invert(1);">
                                    </div>
                                    <div class="text-start flex-grow-1">
                                        <h6 class="mb-2 fw-bold text-dark">ç›®æ¨™è‚Œè‚‰é‡</h6>
                                        <div class="d-flex align-items-center" style="min-width: 0;">
                                            <div class="text-muted fw-normal" style="min-width: 80px;">ç›®å‰: <span
                                                    id="current-muscle" class="fw-semibold">0.0</span> kg</div>
                                            <i class="bi bi-arrow-right text-muted mx-2"></i>
                                            <div class="text-primary fw-semibold">ç›®æ¨™: <span id="goal-muscle-display"
                                                    class="fw-bold">35.0</span> kg</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="px-4">
                                    <button class="btn btn-block btn-xl btn-light-primary font-bold mt-3"
                                        data-bs-toggle="modal" data-bs-target="#setGoalModal">è¨­å®šç›®æ¨™</button>
                                </div>
                            </div>
                        </div>
                        <div class="card text-center equal-h mt-3">
                            <div class="card-header">
                                <h4 class="fw-bold">ç›®æ¨™é”æˆç‡</h4>
                            </div>
                            <div class="card-body d-flex flex-column justify-content-center align-items-center">
                                <div id="goal-progress-chart"
                                    style="width: 100%; aspect-ratio: 1/1; max-height: 200px;"></div>
                                <p class="mt-3 text-muted">é›¢ç›®æ¨™åªå·®ä¸€é»ï¼ŒåŠ æ²¹ï¼</p>
                            </div>
                        </div>
                        <div class="card equal-h mt-3">
                            <div class="card-header">
                                <h4 class="text-center">èº«é«”çµ„æˆæ¯”ä¾‹</h4>
                            </div>
                            <div class="card-body d-flex flex-column justify-content-center align-items-center">
                                <div id="body-composition-pie-chart"></div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <footer>
                <div class="footer clearfix mb-0 text-muted">
                    <div class="float-start">
                        <p>å¥ç¿’ç”Ÿ</p>
                    </div>
                    <div class="float-end">
                        <p>è¬æ˜€å€¢ é»ƒè© ç¿° å‘‚æ²å£ æ¸¸åšç¿”</p>
                    </div>
                </div>
            </footer>
        </div>
    </div>
    <script src="assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>

    <script src="assets/vendors/apexcharts/apexcharts.js"></script>
    <script src="assets/js/pages/dashboard.js"></script>

    <script src="assets/js/main.js"></script>

    <!-- è¨­å®šç›®æ¨™å½ˆå‡ºè¦–çª— -->
    <div class="modal fade" id="setGoalModal" tabindex="-1" aria-labelledby="setGoalModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="setGoalModalLabel">è¨­å®šå¥åº·ç›®æ¨™</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="goalForm">
                        <div class="mb-3">
                            <label for="goal_weight" class="form-label">ç›®æ¨™é«”é‡ (kg)</label>
                            <input type="number" class="form-control" id="goal_weight" name="goal_weight" step="0.1"
                                min="30" max="200" value="70.0">
                        </div>
                        <div class="mb-3">
                            <label for="goal_fat_percentage" class="form-label">ç›®æ¨™é«”è„‚ç‡ (%)</label>
                            <input type="number" class="form-control" id="goal_fat_percentage"
                                name="goal_fat_percentage" step="0.1" min="5" max="50" value="15.0">
                        </div>
                        <div class="mb-3">
                            <label for="goal_muscle" class="form-label">ç›®æ¨™è‚Œè‚‰é‡ (kg)</label>
                            <input type="number" class="form-control" id="goal_muscle" name="goal_muscle" step="0.1"
                                min="10" max="100" value="35.0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" id="saveGoalBtn" class="btn btn-primary">ä¿å­˜ç›®æ¨™</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢æ•¸æ“šå½ˆå‡ºè¦–çª— -->
    <div class="modal fade" id="addDataModal" tabindex="-1" aria-labelledby="addDataModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addDataModalLabel">æ–°å¢å¥åº·æ•¸æ“š</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="healthDataForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="test_date" class="form-label">æ¸¬é‡æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="test_date" name="test_date">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="age" class="form-label">å¹´é½¡ *</label>
                                <input type="number" class="form-control" id="age" name="age" min="1" max="120"
                                    required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="height_cm" class="form-label">èº«é«˜ (cm) *</label>
                                <input type="number" class="form-control" id="height_cm" name="height_cm" step="0.1"
                                    min="50" max="250" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="weight_kg" class="form-label">é«”é‡ (kg) *</label>
                                <input type="number" class="form-control" id="weight_kg" name="weight_kg" step="0.1"
                                    min="20" max="300" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="skeletal_muscle" class="form-label">éª¨éª¼è‚Œé‡ (kg)</label>
                                <input type="number" class="form-control" id="skeletal_muscle" name="skeletal_muscle"
                                    step="0.1">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="body_fat" class="form-label">é«”è„‚è‚ªé‡ (kg)</label>
                                <input type="number" class="form-control" id="body_fat" name="body_fat" step="0.1">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fat_percentage" class="form-label">é«”è„‚ç‡ (%)</label>
                                <input type="number" class="form-control" id="fat_percentage" name="fat_percentage"
                                    step="0.1">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="basal_metabolism" class="form-label">åŸºç¤ä»£è¬é‡ (kcal)</label>
                                <input type="number" class="form-control" id="basal_metabolism" name="basal_metabolism"
                                    step="0.1">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="bmi" class="form-label">BMI (å¯é¸)</label>
                                <input type="number" class="form-control" id="bmi" name="bmi" step="0.1">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveDataBtn">ä¿å­˜æ•¸æ“š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸæç¤ºè¦–çª— -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æˆåŠŸ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="successMessage">æ•¸æ“šä¿å­˜æˆåŠŸï¼</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- éŒ¯èª¤æç¤ºè¦–çª— -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">éŒ¯èª¤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="errorMessage">ä¿å­˜æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¨­ç½®ä»Šå¤©çš„æ—¥æœŸç‚ºé»˜èªå€¼ï¼ˆä½¿ç”¨æœ¬åœ°æ™‚å€ï¼‰
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('test_date').value = `${year}-${month}-${day}`;

        // è¼‰å…¥ç”¨æˆ¶è³‡è¨Š
        fetch('get_user_info.php')
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    // å¦‚æœæœªç™»å…¥ï¼Œè·³è½‰åˆ°ç™»å…¥é é¢
                    window.location.href = 'auth-login.html';
                    throw new Error('Not logged in');
                }
            })
            .then(data => {
                // æ›´æ–°ç”¨æˆ¶è³‡è¨Š
                document.getElementById('user-id').textContent = data.userid;
                document.getElementById('user-name').textContent = data.username;
                document.getElementById('user-email').textContent = data.email;

                // æ›´æ–°ç”¨æˆ¶å¤§é ­è²¼
                const userAvatar = document.querySelector('.avatar img');
                if (data.avatar && data.avatar.trim() !== '') {
                    userAvatar.src = data.avatar;
                    userAvatar.alt = data.username + ' çš„å¤§é ­è²¼';
                } else {
                    // å¦‚æœæ²’æœ‰ä¸Šå‚³å¤§é ­è²¼ï¼Œä½¿ç”¨é è¨­åœ–ç‰‡
                    userAvatar.src = 'assets/images/faces/1.jpg';
                    userAvatar.alt = 'é è¨­å¤§é ­è²¼';
                }
            })
            .catch(error => {
                console.error('Error loading user info:', error);
            });

        // è¼‰å…¥å¥åº·æ•¸æ“šçµ±è¨ˆ
        fetch('get_health_stats.php')
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Failed to load health stats');
                }
            })
            .then(data => {
                // æ›´æ–°çµ±è¨ˆæ•¸æ“šï¼ˆé¡¯ç¤ºæœ€æ–°è¨˜éŒ„ï¼‰
                document.getElementById('total-records').textContent = data.total_records + ' ç­†';
                document.getElementById('avg-weight').textContent = data.latest_weight + ' kg';
                document.getElementById('avg-height').textContent = data.latest_height + ' cm';
                document.getElementById('avg-skeletal').textContent = data.latest_skeletal_muscle + ' kg';
                document.getElementById('avg-body-fat').textContent = data.latest_body_fat + ' kg';
                document.getElementById('avg-fat-percentage').textContent = data.latest_fat_percentage + '%';
                document.getElementById('avg-metabolism').textContent = data.latest_basal_metabolism + ' kcal';
                document.getElementById('avg-bmi').textContent = data.latest_bmi;

                // æ›´æ–°ç›®æ¨™è¿½è¹¤çš„ç›®å‰æ•¸æ“š
                document.getElementById('current-weight').textContent = data.latest_weight;
                document.getElementById('current-fat-percentage').textContent = data.latest_fat_percentage;
                document.getElementById('current-muscle').textContent = data.latest_skeletal_muscle;

                // æ›´æ–°ç›®æ¨™é”æˆç‡åœ–è¡¨
                if (window.goalProgressChart) {
                    window.goalProgressChart.update();
                }
            })
            .catch(error => {
                console.error('Error loading health stats:', error);
            });

        // è¼‰å…¥åœ–è¡¨æ•¸æ“š
        function loadChartData(startDate = null, endDate = null) {
            let url = 'get_chart_data.php';
            const params = new URLSearchParams();

            if (startDate && endDate) {
                params.append('start_date', startDate);
                params.append('end_date', endDate);
                url += '?' + params.toString();
                console.log('Loading chart data with date range:', startDate, 'to', endDate);
            } else {
                console.log('Loading all chart data (no date filter)');
            }

            console.log('Loading chart data from:', url);

            fetch(url)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Failed to load chart data');
                    }
                })
                .then(data => {
                    console.log('Chart data received:', data);
                    console.log('Total records:', data.total_records);
                    console.log('Date filter applied:', data.date_filter_applied);
                    console.log('Filter start date:', data.filter_start_date);
                    console.log('Filter end date:', data.filter_end_date);
                    console.log('Dates:', data.dates);
                    console.log('Weight data:', data.weight);

                    if (data.dates && data.dates.length > 0) {
                        createWeightChart(data);
                        createBodyCompositionChart(data);
                        createFatPercentageChart(data);
                        createBMIChart(data);
                    } else {
                        console.warn('No chart data available');
                    }
                })
                .catch(error => {
                    console.error('Error loading chart data:', error);
                });
        }

        // å‰µå»ºé«”é‡è®ŠåŒ–åœ–è¡¨
        function createWeightChart(data) {
            // æ¸…é™¤èˆŠçš„åœ–è¡¨
            const chartContainer = document.querySelector("#weight-chart");
            chartContainer.innerHTML = '';

            const weightData = data.weight.filter(val => val !== null);
            const dates = data.dates.filter((_, index) => data.weight[index] !== null);

            if (weightData.length === 0) return;

            const options = {
                series: [{
                    name: 'é«”é‡ (kg)',
                    data: weightData
                }],
                chart: {
                    type: 'line',
                    height: 390,
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#AB8B8B'],
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val.toFixed(1);
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                xaxis: {
                    categories: dates,
                    labels: {
                        formatter: function (value) {
                            return new Date(value).toLocaleDateString('zh-TW', {
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'é«”é‡ (kg)'
                    }
                },
                tooltip: {
                    x: {
                        format: 'dd/MM/yyyy'
                    }
                }
            };

            const chart = new ApexCharts(chartContainer, options);
            chart.render();
        }

        // å‰µå»ºèº«é«”çµ„æˆåœ–è¡¨
        function createBodyCompositionChart(data) {
            // æ¸…é™¤èˆŠçš„åœ–è¡¨
            const chartContainer = document.querySelector("#body-composition-chart");
            chartContainer.innerHTML = '';

            const skeletalData = data.skeletal_muscle.filter(val => val !== null);
            const bodyFatData = data.body_fat.filter(val => val !== null);
            const dates = data.dates.filter((_, index) =>
                data.skeletal_muscle[index] !== null || data.body_fat[index] !== null
            );

            if (skeletalData.length === 0 && bodyFatData.length === 0) return;

            const options = {
                series: [{
                    name: 'éª¨éª¼è‚Œé‡ (kg)',
                    data: skeletalData
                }, {
                    name: 'é«”è„‚è‚ªé‡ (kg)',
                    data: bodyFatData
                }],
                chart: {
                    type: 'line',
                    height: 390,
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#99898C', '#60575A'],
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val.toFixed(1);
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                xaxis: {
                    categories: dates,
                    labels: {
                        formatter: function (value) {
                            return new Date(value).toLocaleDateString('zh-TW', {
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'é‡é‡ (kg)'
                    }
                },
                tooltip: {
                    x: {
                        format: 'dd/MM/yyyy'
                    }
                }
            };

            const chart = new ApexCharts(chartContainer, options);
            chart.render();
        }

        // å‰µå»ºé«”è„‚ç‡è®ŠåŒ–åœ–è¡¨
        function createFatPercentageChart(data) {
            // æ¸…é™¤èˆŠçš„åœ–è¡¨
            const chartContainer = document.querySelector("#fat-percentage-chart");
            chartContainer.innerHTML = '';

            const fatPercentageData = data.fat_percentage.filter(val => val !== null);
            const dates = data.dates.filter((_, index) => data.fat_percentage[index] !== null);

            if (fatPercentageData.length === 0) return;

            const options = {
                series: [{
                    name: 'é«”è„‚ç‡ (%)',
                    data: fatPercentageData
                }],
                chart: {
                    type: 'line',
                    height: 390,
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#745E60'],
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val.toFixed(1);
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                xaxis: {
                    categories: dates,
                    labels: {
                        formatter: function (value) {
                            return new Date(value).toLocaleDateString('zh-TW', {
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'é«”è„‚ç‡ (%)'
                    }
                },
                tooltip: {
                    x: {
                        format: 'dd/MM/yyyy'
                    }
                }
            };

            const chart = new ApexCharts(chartContainer, options);
            chart.render();
        }

        // å‰µå»ºBMIè®ŠåŒ–åœ–è¡¨
        function createBMIChart(data) {
            // æ¸…é™¤èˆŠçš„åœ–è¡¨
            const chartContainer = document.querySelector("#bmi-chart");
            chartContainer.innerHTML = '';

            const bmiData = data.bmi.filter(val => val !== null);
            const dates = data.dates.filter((_, index) => data.bmi[index] !== null);

            if (bmiData.length === 0) return;

            const options = {
                series: [{
                    name: 'BMI',
                    data: bmiData
                }],
                chart: {
                    type: 'line',
                    height: 390,
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#9C7178'],
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val.toFixed(1);
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                xaxis: {
                    categories: dates,
                    labels: {
                        formatter: function (value) {
                            return new Date(value).toLocaleDateString('zh-TW', {
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'BMI'
                    }
                },
                tooltip: {
                    x: {
                        format: 'dd/MM/yyyy'
                    }
                }
            };

            const chart = new ApexCharts(chartContainer, options);
            chart.render();
        }

        // åˆå§‹åŒ–æ™‚é–“ç¯„åœé¸æ“‡å™¨
        function initializeDateRange() {
            // ä¸è¨­ç½®é è¨­å€¼ï¼Œè®“ç”¨æˆ¶è‡ªå·±é¸æ“‡
            console.log('Date range selector initialized - no default values set');
        }

        // æ™‚é–“ç¯„åœé¸æ“‡å™¨äº‹ä»¶è™•ç†
        document.getElementById('apply-date-range').addEventListener('click', function () {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (startDate && endDate) {
                if (startDate > endDate) {
                    alert('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸï¼');
                    return;
                }
                console.log('Applying date range:', startDate, 'to', endDate);
                loadChartData(startDate, endDate);
            } else {
                alert('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸï¼');
            }
        });

        document.getElementById('reset-date-range').addEventListener('click', function () {
            // æ¸…é™¤æ—¥æœŸé¸æ“‡å™¨
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            console.log('Date range reset - loading all data');
            loadChartData(); // è¼‰å…¥æ‰€æœ‰æ•¸æ“š
        });

        // æœ€è¿‘30å¤©æŒ‰éˆ•äº‹ä»¶
        document.getElementById('last-30-days').addEventListener('click', function () {
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);

            document.getElementById('start-date').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            console.log('Last 30 days selected:', thirtyDaysAgo.toISOString().split('T')[0], 'to', today.toISOString().split('T')[0]);
            loadChartData(thirtyDaysAgo.toISOString().split('T')[0], today.toISOString().split('T')[0]);
        });

        // åˆå§‹åŒ–æ™‚é–“ç¯„åœé¸æ“‡å™¨
        initializeDateRange();

        // è¼‰å…¥åœ–è¡¨æ•¸æ“š
        loadChartData();
        // ç›®æ¨™é”æˆç‡åœ“ç’°åœ– - å‹•æ…‹è¨ˆç®—
        function createGoalProgressChart() {
            var chartDom = document.querySelector("#goal-progress-chart");
            var myChart = echarts.init(chartDom);

            // è¨ˆç®—ç›®æ¨™é”æˆç‡
            function calculateGoalProgress() {
                const currentWeight = parseFloat(document.getElementById('current-weight').textContent) || 0;
                const currentFatPercentage = parseFloat(document.getElementById('current-fat-percentage').textContent) || 0;
                const currentMuscle = parseFloat(document.getElementById('current-muscle').textContent) || 0;

                const goalWeight = parseFloat(document.getElementById('goal-weight-display').textContent) || 70;
                const goalFatPercentage = parseFloat(document.getElementById('goal-fat-percentage-display').textContent) || 15;
                const goalMuscle = parseFloat(document.getElementById('goal-muscle-display').textContent) || 35;

                // è¨ˆç®—å„é …æŒ‡æ¨™çš„é”æˆç‡ (0-100%)
                let weightProgress = 0;
                let fatProgress = 0;
                let muscleProgress = 0;

                // é«”é‡é”æˆç‡ï¼šåŸºæ–¼ç›®å‰é«”é‡èˆ‡ç›®æ¨™é«”é‡çš„å·®è·è¨ˆç®—
                if (currentWeight > 0 && goalWeight > 0) {
                    if (currentWeight > goalWeight) {
                        // æ¸›é‡æƒ…æ³ï¼šç›®å‰é«”é‡ > ç›®æ¨™é«”é‡
                        // å‡è¨­èµ·å§‹é«”é‡æ˜¯ç›®æ¨™é«”é‡çš„ 1.2 å€ï¼ˆ20% è¶…é‡ï¼‰
                        const startWeight = goalWeight * 1.2;
                        const totalToLose = startWeight - goalWeight;
                        const alreadyLost = startWeight - currentWeight;
                        weightProgress = Math.min(100, Math.max(0, (alreadyLost / totalToLose) * 100));
                    } else if (currentWeight <= goalWeight) {
                        // å·²é”åˆ°æˆ–è¶…éç›®æ¨™é«”é‡
                        weightProgress = 100;
                    }
                }

                // é«”è„‚ç‡é”æˆç‡ï¼šåŸºæ–¼ç›®å‰é«”è„‚ç‡èˆ‡ç›®æ¨™é«”è„‚ç‡çš„å·®è·è¨ˆç®—
                if (currentFatPercentage > 0 && goalFatPercentage > 0) {
                    if (currentFatPercentage > goalFatPercentage) {
                        // é™ä½é«”è„‚ç‡æƒ…æ³
                        // å‡è¨­èµ·å§‹é«”è„‚ç‡æ˜¯ç›®æ¨™é«”è„‚ç‡çš„ 1.5 å€ï¼ˆ50% è¶…æ¨™ï¼‰
                        const startFatPercentage = goalFatPercentage * 1.5;
                        const totalToReduce = startFatPercentage - goalFatPercentage;
                        const alreadyReduced = startFatPercentage - currentFatPercentage;
                        fatProgress = Math.min(100, Math.max(0, (alreadyReduced / totalToReduce) * 100));
                    } else if (currentFatPercentage <= goalFatPercentage) {
                        // å·²é”åˆ°æˆ–è¶…éç›®æ¨™é«”è„‚ç‡
                        fatProgress = 100;
                    }
                }

                // è‚Œè‚‰é‡é”æˆç‡ï¼šåŸºæ–¼ç›®å‰è‚Œè‚‰é‡èˆ‡ç›®æ¨™è‚Œè‚‰é‡çš„å·®è·è¨ˆç®—
                if (currentMuscle > 0 && goalMuscle > 0) {
                    if (currentMuscle < goalMuscle) {
                        // å¢è‚Œæƒ…æ³
                        // å‡è¨­èµ·å§‹è‚Œè‚‰é‡æ˜¯ç›®æ¨™è‚Œè‚‰é‡çš„ 0.8 å€ï¼ˆ20% ä¸è¶³ï¼‰
                        const startMuscle = goalMuscle * 0.8;
                        const totalToGain = goalMuscle - startMuscle;
                        const alreadyGained = currentMuscle - startMuscle;
                        muscleProgress = Math.min(100, Math.max(0, (alreadyGained / totalToGain) * 100));
                    } else if (currentMuscle >= goalMuscle) {
                        // å·²é”åˆ°æˆ–è¶…éç›®æ¨™è‚Œè‚‰é‡
                        muscleProgress = 100;
                    }
                }

                // è¨ˆç®—ç¶œåˆé”æˆç‡ (åŠ æ¬Šå¹³å‡)
                const overallProgress = Math.round((weightProgress * 0.4 + fatProgress * 0.3 + muscleProgress * 0.3));

                return Math.min(100, Math.max(0, overallProgress));
            }

            // æ›´æ–°åœ–è¡¨
            function updateGoalProgressChart(progress) {
                const progressDecimal = progress / 100;

                var option = {
                    series: [{
                        type: 'liquidFill',
                        data: [progressDecimal],
                        radius: '65%',
                        center: ['50%', '50%'],
                        outline: {
                            show: true,
                            borderDistance: 3,
                            itemStyle: {
                                borderWidth: 2,
                                borderColor: '#6b7b8c'
                            }
                        },
                        backgroundStyle: { color: '#f5f7fa' },
                        label: {
                            normal: {
                                formatter: progress + '%',
                                fontSize: 20,
                                color: '#34495e',
                                fontWeight: 'bold'
                            }
                        },
                        color: [{
                            type: 'linear',
                            x: 0, y: 0, x2: 0, y2: 1,
                            colorStops: [
                                { offset: 0, color: '#9c99a2' },
                                { offset: 1, color: '#cddce6' }
                            ]
                        }]
                    }]
                };

                myChart.setOption(option);
            }

            // åˆå§‹è¨ˆç®—ä¸¦æ›´æ–°åœ–è¡¨
            const initialProgress = calculateGoalProgress();
            updateGoalProgressChart(initialProgress);

            // è®“åœ–è¡¨è·Ÿéš¨è¦–çª—å¤§å°ç¸®æ”¾
            window.addEventListener("resize", function () {
                myChart.resize();
            });

            // è¿”å›æ›´æ–°å‡½æ•¸ï¼Œä¾›å…¶ä»–åœ°æ–¹èª¿ç”¨
            return {
                update: function () {
                    const progress = calculateGoalProgress();
                    updateGoalProgressChart(progress);
                }
            };
        }
        // å‰µå»ºç›®æ¨™é”æˆç‡åœ–è¡¨ä¸¦ä¿å­˜æ›´æ–°å‡½æ•¸
        window.goalProgressChart = createGoalProgressChart();

        // å‰µå»ºèº«é«”çµ„æˆæ¯”ä¾‹åœ“é¤…åœ–
        function createBodyCompositionPieChart() {
            // æ¸…é™¤èˆŠçš„åœ–è¡¨
            const chartContainer = document.querySelector("#body-composition-pie-chart");
            chartContainer.innerHTML = '';

            fetch('get_health_stats.php')
                .then(response => response.json())
                .then(data => {
                    const latestSkeletal = parseFloat(data.latest_skeletal_muscle) || 0;
                    const latestBodyFat = parseFloat(data.latest_body_fat) || 0;
                    const latestWeight = parseFloat(data.latest_weight) || 0;

                    // è¨ˆç®—å…¶ä»–çµ„æˆï¼ˆé«”é‡ - éª¨éª¼è‚Œ - é«”è„‚è‚ªï¼‰
                    const otherComposition = Math.max(0, latestWeight - latestSkeletal - latestBodyFat);

                    const options = {
                        series: [latestSkeletal, latestBodyFat, otherComposition],
                        chart: {
                            type: 'donut',
                            height: 260
                        },
                        labels: ['éª¨éª¼è‚Œ', 'é«”è„‚è‚ª', 'å…¶ä»–'],
                        colors: ['#BFC5DB', '#B2ABC5', '#C7C7C7'],
                        dataLabels: {
                            enabled: true,
                            formatter: function (val, opts) {
                                return opts.w.globals.series[opts.seriesIndex].toFixed(1) + ' kg';
                            }
                        },
                        legend: {
                            position: 'bottom'
                        },
                        plotOptions: {
                            pie: {
                                donut: {
                                    size: '60%',
                                    labels: {
                                        show: true,
                                        total: {
                                            show: true,
                                            label: 'ç¸½é‡é‡',
                                            formatter: function (w) {
                                                return w.globals.seriesTotals.reduce((a, b) => a + b, 0).toFixed(1) + ' kg';
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    };

                    const chart = new ApexCharts(chartContainer, options);
                    chart.render();
                })
                .catch(error => {
                    console.error('Error creating body composition pie chart:', error);
                });
        }

        // è¼‰å…¥èº«é«”çµ„æˆæ¯”ä¾‹åœ–è¡¨
        createBodyCompositionPieChart();

        // è¨­å®šç›®æ¨™åŠŸèƒ½
        document.getElementById('saveGoalBtn').addEventListener('click', function () {
            const goalWeight = document.getElementById('goal_weight').value;
            const goalFatPercentage = document.getElementById('goal_fat_percentage').value;
            const goalMuscle = document.getElementById('goal_muscle').value;

            // æ›´æ–°é¡¯ç¤ºçš„ç›®æ¨™å€¼
            document.getElementById('goal-weight-display').textContent = goalWeight;
            document.getElementById('goal-fat-percentage-display').textContent = goalFatPercentage;
            document.getElementById('goal-muscle-display').textContent = goalMuscle;

            // é—œé–‰è¨­å®šç›®æ¨™è¦–çª—
            const setGoalModal = bootstrap.Modal.getInstance(document.getElementById('setGoalModal'));
            setGoalModal.hide();

            // æ›´æ–°ç›®æ¨™é”æˆç‡åœ–è¡¨
            if (window.goalProgressChart) {
                window.goalProgressChart.update();
            }

            // é¡¯ç¤ºæˆåŠŸæç¤º
            document.getElementById('successMessage').textContent = 'ç›®æ¨™è¨­å®šæˆåŠŸï¼';
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            successModal.show();
        });

        // ä¿å­˜æ•¸æ“šæŒ‰éˆ•é»æ“Šäº‹ä»¶
        document.getElementById('saveDataBtn').addEventListener('click', function () {
            // é¡¯ç¤ºä¿å­˜ä¸­ç‹€æ…‹
            const saveBtn = document.getElementById('saveDataBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';

            const form = document.getElementById('healthDataForm');
            const formData = new FormData(form);

            // å°‡FormDataè½‰æ›ç‚ºJSONå°è±¡
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            // ç™¼é€æ•¸æ“šåˆ°æœå‹™å™¨
            fetch('save_health_data.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'ä¿å­˜æ•¸æ“š';

                    if (result.success) {
                        // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
                        document.getElementById('successMessage').textContent = result.message;
                        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                        successModal.show();

                        // é—œé–‰æ–°å¢æ•¸æ“šè¦–çª—
                        const addDataModal = bootstrap.Modal.getInstance(document.getElementById('addDataModal'));
                        addDataModal.hide();

                        // é‡ç½®è¡¨å–®
                        form.reset();
                        // é‡æ–°è¨­ç½®ä»Šå¤©çš„æ—¥æœŸç‚ºé»˜èªå€¼
                        const today = new Date();
                        const year = today.getFullYear();
                        const month = String(today.getMonth() + 1).padStart(2, '0');
                        const day = String(today.getDate()).padStart(2, '0');
                        document.getElementById('test_date').value = `${year}-${month}-${day}`;

                        // é‡æ–°è¼‰å…¥çµ±è¨ˆæ•¸æ“š
                        fetch('get_health_stats.php')
                            .then(response => response.json())
                            .then(data => {
                                document.getElementById('total-records').textContent = data.total_records + ' ç­†';
                                document.getElementById('avg-weight').textContent = data.latest_weight + ' kg';
                                document.getElementById('avg-height').textContent = data.latest_height + ' cm';
                                document.getElementById('avg-skeletal').textContent = data.latest_skeletal_muscle + ' kg';
                                document.getElementById('avg-body-fat').textContent = data.latest_body_fat + ' kg';
                                document.getElementById('avg-fat-percentage').textContent = data.latest_fat_percentage + '%';
                                document.getElementById('avg-metabolism').textContent = data.latest_basal_metabolism + ' kcal';
                                document.getElementById('avg-bmi').textContent = data.latest_bmi;
                            })
                            .catch(error => {
                                console.error('Error reloading health stats:', error);
                            });

                        // é‡æ–°è¼‰å…¥åœ–è¡¨æ•¸æ“š
                        const startDate = document.getElementById('start-date').value;
                        const endDate = document.getElementById('end-date').value;
                        if (startDate && endDate) {
                            loadChartData(startDate, endDate);
                        } else {
                            loadChartData();
                        }
                    } else {
                        // é¡¯ç¤ºéŒ¯èª¤æ¶ˆæ¯
                        document.getElementById('errorMessage').textContent = result.error || 'ä¿å­˜æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤';
                        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                        errorModal.show();
                    }
                })
                .catch(error => {
                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'ä¿å­˜æ•¸æ“š';

                    console.error('Error:', error);
                    document.getElementById('errorMessage').textContent = 'ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
                    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
                    errorModal.show();
                });
        });
        document.addEventListener("DOMContentLoaded", function () {
            flatpickr("#start-date", {
                dateFormat: "Y-m-d",   // å‚³çµ¦å¾Œç«¯çš„æ ¼å¼ï¼š2025-09-01
                altInput: true,        // é¡¯ç¤ºæ›¿ä»£è¼¸å…¥æ¡†
                altFormat: "Yå¹´mæœˆdæ—¥", // ä½¿ç”¨è€…çœ‹åˆ°çš„æ ¼å¼ï¼š2025å¹´09æœˆ01æ—¥
                locale: "zh"           // ä¸­æ–‡èªç³»
            });

            flatpickr("#end-date", {
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "Yå¹´mæœˆdæ—¥",
                locale: "zh"
            });
        });
        document.addEventListener("DOMContentLoaded", function () {
            // é–‹å§‹æ—¥æœŸ
            flatpickr("#start-date", {
                dateFormat: "Y-m-d",     // å¾Œç«¯æ ¼å¼ï¼š2025-09-01
                altInput: true,          // é¡¯ç¤ºæ›¿ä»£è¼¸å…¥æ¡†
                altFormat: "Yå¹´mæœˆdæ—¥",   // ä½¿ç”¨è€…çœ‹åˆ°çš„æ ¼å¼
                locale: "zh"             // ä¸­æ–‡ä»‹é¢
            });

            // çµæŸæ—¥æœŸ
            flatpickr("#end-date", {
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "Yå¹´mæœˆdæ—¥",
                locale: "zh"
            });
        });
    </script>
</body>

</html>